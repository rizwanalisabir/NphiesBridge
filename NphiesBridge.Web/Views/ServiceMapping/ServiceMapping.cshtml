@using NphiesBridge.Shared.DTOs
@model ServiceMappingPageDto

@{
    ViewData["Title"] = "Service Code Mapping";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

    <!-- Reuse existing styles -->
    <link rel="stylesheet" href="~/css/icd-mapping.css" asp-append-version="true" />


<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
                <h2 class="fw-bold text-primary mb-1">Service Code Mapping</h2>
                <p class="text-white mb-0">
                    Map your hospital service codes to NPHIES standardized codes. Use AI-powered suggestions or manual mapping for accuracy.
                </p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-secondary btn-pause">
                    <i data-lucide="pause" style="width:18px;height:18px;"></i>
                    <span class="ms-1">Pause Processing</span>
                </button>
                <button type="button" class="btn btn-success" onclick="approveAllService()">
                    <i data-lucide="check-circle" style="width:18px;height:18px;"></i>
                    <span class="ms-1">Approve High-Confidence</span>
                </button>
                <button type="button" class="btn btn-outline-primary btn-export" onclick="exportServiceResults()">
                    <i data-lucide="download" style="width:18px;height:18px;"></i>
                    <span class="ms-1">Export</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress and counters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex align-items-center flex-wrap gap-3 mb-2">
                <div id="progressText" class="text-white mr-4">Initializing...</div>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <span>Done: <strong id="completedCount" class="ml-1 mr-2">0</strong></span>
                    <span>Processing: <strong id="processingCount" class="ml-1 mr-2">0</strong></span>
                    <span>Pending: <strong id="pendingCount" class="ml-1 mr-2">0</strong></span>
                    <span>Total: <strong id="totalCount" class="ml-1 mr-2">@Model.TotalRows</strong></span>
                </div>
            </div>
            <div class="progress" style="height: 10px;">
                <div id="overallProgress" class="progress-bar" role="progressbar" style="width:0%;" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>

    <!-- Mapping content containers expected by service-mapping.js -->
    <div id="loadingState" class="card shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
            <div class="spinner-border text-primary" role="status" style="width:1.5rem;height:1.5rem;"></div>
            <div>Loading session...</div>
        </div>
    </div>

    <div id="mappingRows" style="display:none;"></div>

    <!-- Optional: Manual Mapping Modal (kept for future manual mapping UX) -->
    <div class="modal fade" id="manualMappingModal" tabindex="-1" aria-labelledby="manualMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- TODO: Implement manual mapping form (not required for auto/AI flow) -->
                <div class="modal-header">
                    <h5 class="modal-title" id="manualMappingModalLabel">Manual Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Manual mapping form will appear here...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page wiring -->
<script>
    // Provide configuration to service-mapping.js
    window.mappingData = {
        sessionId: '@Model.SessionId',
        totalRows: @Model.TotalRows,
         apiUrls: {
                    baseUrl: '@ViewBag.ApiBaseUrl'
                }
    };
</script>

<!-- Include the Service Mapping JS engine -->
<script src="~/js/service-mapping.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize icons if available (optional)
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Kick off the mapping UI and progressive processing
        if (typeof initializeServiceMappingProcess === 'function') {
            initializeServiceMappingProcess();
        } else if (typeof initializeMappingProcess === 'function') {
            // Backwards compatibility alias exposed by the JS
            initializeMappingProcess();
        } else {
            console.error('Service mapping initializer not found. Is service-mapping.js loaded?');
        }
    });
</script>