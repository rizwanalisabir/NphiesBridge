@model NphiesBridge.Shared.DTOs.ServiceMappingPageDto
@{
    ViewData["Title"] = "Service Codes Mapping";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var stats = ViewBag.Statistics as NphiesBridge.Shared.DTOs.ServiceMappingStatisticsDto;
    var apiErrors = ViewBag.ApiErrors as List<string> ?? new();
}
<link href="~/css/icd-mapping.css" rel="stylesheet" />

<div class="container-fluid" id="svc-mapping" data-session="@Model.SessionId">
    <div class="mapping-container mx-auto" style="max-width: 1400px;">

        <!-- Header -->
        <div class="mapping-header">
            <h2 class="fw-bold mb-2">AI-Powered Service Codes Mapping</h2>
            <p class="mb-0 opacity-75">Match your service codes with NPHIES standards using AI assistance</p>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-number">@((stats?.MappedCodes ?? 0))</div>
                    <div class="stat-label">Mapped</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">@((stats?.TotalCodes ?? 0) - (stats?.MappedCodes ?? 0))</div>
                    <div class="stat-label">Unmapped</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">@Model.TotalRows</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">@((stats?.CompletionPercentage ?? 0).ToString("0"))%</div>
                    <div class="stat-label">Completion</div>
                </div>
            </div>
            <div class="overall-progress">
                <div class="overall-progress-fill" style="width: @((stats?.CompletionPercentage ?? 0).ToString("0"))%"></div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted fw-medium">
                    Session: @Model.SessionId
                </small>
            </div>
        </div>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger mt-2">@TempData["Error"]</div>
        }
        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success mt-2">@TempData["Message"]</div>
        }
        @if (apiErrors.Count > 0)
        {
            <div class="alert alert-warning mt-2">
                @foreach (var e in apiErrors)
                {
                    <div>@e</div>
                }
            </div>
        }

        <!-- Mapping Rows -->
        <div class="card mt-3">
            <div class="card-body">

                <!-- Toolbar -->
                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                    <div class="input-group" style="max-width: 360px;">
                        <span class="input-group-text"><i class="zmdi zmdi-search"></i></span>
                        <input id="svc-search" type="text" class="form-control" placeholder="Search by Name, ItemRelation, NPHIES code...">
                    </div>

                    <div class="form-check form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="svc-filter-unmapped" checked>
                        <label class="form-check-label" for="svc-filter-unmapped">Show Unmapped Only</label>
                    </div>

                    <div class="ms-auto d-flex flex-wrap gap-2">
                        <form id="svc-generate-form" asp-action="GenerateSuggestions" asp-controller="ServiceCodesMapping" method="post" class="d-inline">
                            <input type="hidden" name="sessionId" value="@Model.SessionId" />
                            @Html.AntiForgeryToken()
                            <button type="submit" class="control-btn btn-export">
                                <i data-lucide="sparkles" style="width: 18px; height: 18px;"></i>
                                Generate Suggestions (max 100)
                            </button>
                        </form>
                        <form id="svc-approve-form" asp-action="ApproveAllHigh" asp-controller="ServiceCodesMapping" method="post" class="d-inline">
                            <input type="hidden" name="sessionId" value="@Model.SessionId" />
                            @Html.AntiForgeryToken()
                            <button type="submit" class="control-btn btn-approve-all">
                                <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                                Approve All High
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table id="svc-table" class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 16%;">ItemRelation</th>
                                <th style="width: 10%;">ItemId</th>
                                <th>Name</th>
                                <th style="width: 14%;">Current NPHIES</th>
                                <th style="width: 14%;">Suggested</th>
                                <th style="width: 10%;">Confidence</th>
                                <th style="width: 21%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ProviderItems == null || Model.ProviderItems.Count == 0)
                            {
                                <tr><td colspan="8" class="text-center text-muted">No items found.</td></tr>
                            }
                            else
                            {
                                var idx = 0;
                                foreach (var row in Model.ProviderItems)
                                {
                                    idx++;
                                    <tr data-row
                                        data-mapped="@(row.IsMapped ? "1" : "0")"
                                        data-name="@row.Name"
                                        data-itemrelation="@row.ItemRelation"
                                        data-nphies="@row.NphiesCode"
                                        data-suggested="@row.SuggestedNphiesCode">
                                        <td>@idx</td>
                                        <td class="text-nowrap">@row.ItemRelation</td>
                                        <td>@row.ItemId</td>
                                        <td>@row.Name</td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(row.NphiesCode))
                                            {
                                                <span class="badge bg-info">@row.NphiesCode</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(row.SuggestedNphiesCode))
                                            {
                                                <span class="badge bg-warning text-dark">@row.SuggestedNphiesCode</span>
                                                <div class="small text-muted">@row.MatchReason</div>
                                            }
                                        </td>
                                        <td>
                                            @if (row.ConfidenceScore > 0)
                                            {
                                                <span>@row.ConfidenceScore%</span>
                                            }
                                        </td>
                                        <td>
                                            <form class="svc-save-form row row-cols-lg-auto g-1 align-items-center" method="post" action="@Url.Action("SaveRowMappingAjax","ServiceCodesMapping")">
                                                <input type="hidden" name="ProviderServiceItemId" value="@row.Id" />
                                                <input type="hidden" name="IsAiSuggested" value="@(row.SuggestedNphiesCode != null)" />
                                                <input type="hidden" name="ConfidenceScore" value="@(row.ConfidenceScore > 0 ? row.ConfidenceScore.ToString() : null)" />
                                                <input type="hidden" name="sessionId" value="@Model.SessionId" />
                                                <div class="col-12">
                                                    <input type="text" class="form-control form-control-sm" name="NphiesServiceCode" placeholder="Enter NPHIES code" value="@(row.NphiesCode ?? row.SuggestedNphiesCode ?? "")" required />
                                                </div>
                                                <div class="col-12">
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <span class="btn-text">Save</span>
                                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                    </button>
                                                </div>
                                                @Html.AntiForgeryToken()
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 small text-muted">
                    Showing up to 100 items. Use Generate Suggestions to prefill, then Approve High, and save any manual edits inline.
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/service-codes-mapping.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        });
    </script>
